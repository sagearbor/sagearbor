name: My Independent Code Analyzer
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  analyze-code:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout profile repository
        uses: actions/checkout@v4

      - name: Install Dependencies (cloc and gh)
        run: |
          sudo apt-get update
          sudo apt-get install -y cloc gh
          touch loc_report.txt # Ensure report file exists

      - name: Analyze CURRENT Repository (sagearbor)
        run: |
          echo "--- Analyzing current repo (${{ github.repository }} ---"
          cloc . --exclude-dir=node_modules,.github,vendor --md >> loc_report.txt

      - name: Fetch & Analyze OTHER Repositories
        run: |
          mkdir -p /tmp/other_repos
          cd /tmp/other_repos
          
          # Fix the shell loop interaction to prevent "Too many arguments" error
          gh repo list ${{ github.repository_owner }} --source --json name | jq -r '.[].name' | while IFS= read -r repo_name; do
            if [ "$repo_name" != "${{ github.event.repository.name }}" ]; then
              echo "--- Cloning and analyzing $repo_name ---"
              # Ensure clone command is clean
              git clone --depth 1 "github.com{{ github.repository_owner }}/$repo_name.git"
              # Analyze the repo inside /tmp/other_repos directory
              cloc "$repo_name" --exclude-dir=node_modules,vendor --md >> /home/runner/work/sagearbor/sagearbor/loc_report.txt
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }} # The secret you created

      - name: Append Report to README
        run: |
          # Remove old report if it exists before appending new data
          sed -i '/^## Lines of Code Report/,/^\s*$/d' README.md || true
          echo "## Lines of Code Report" >> README.md
          cat loc_report.txt >> README.md

      - name: Commit Report Update
        uses: actions-js/push@v1
        with:
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          branch: main
          message: "Auto-generated: Update Lines of Code Report"
