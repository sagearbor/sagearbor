name: My Independent Code Analyzer
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  analyze-code:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout profile repository
        uses: actions/checkout@v4

      - name: Install Dependencies (cloc and gh)
        run: |
          sudo apt-get update
          sudo apt-get install -y cloc gh

      - name: Fetch & Analyze ALL User Repositories
        # CRITICAL FIX: Pass GITHUB_TOKEN as an environment variable (GH_TOKEN)
        run: |
          echo "Fetching and analyzing repositories for ${{ github.repository_owner }}"
          
          # Use the GitHub CLI to clone and analyze all user repos (excluding forks)
          gh repo list ${{ github.repository_owner }} --source --json name | jq -r '.[].name' | while read repo_name; do
            echo "--- Cloning and analyzing $repo_name ---"
            git clone --depth 1 github.com{{ github.repository_owner }}/$repo_name.git
            # Append markdown table format output to the report file
            cloc $repo_name --exclude-dir=node_modules,vendor --md >> loc_report.txt
          done
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }} # The secret you created

      - name: Append Report to README
        run: |
          echo "## Lines of Code Report" >> README.md
          # Only proceed if the file was created
          if [ -f loc_report.txt ]; then
            cat loc_report.txt >> README.md
          else
            echo "No repositories found or report was empty." >> README.md
          fi

      - name: Commit Report Update
        uses: actions-js/push@v1
        with:
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          branch: main
          message: "Auto-generated: Update Lines of Code Report"
