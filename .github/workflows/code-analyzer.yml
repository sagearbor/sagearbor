name: My Independent Code Analyzer
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  analyze-code:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout profile repository
        uses: actions/checkout@v4

      - name: Install Dependencies (cloc and gh)
        run: |
          sudo apt-get update
          sudo apt-get install -y cloc gh
          touch loc_report.txt

      - name: Analyze CURRENT Repository (sagearbor)
        run: |
          echo "--- Analyzing current repo (${{ github.repository }}) ---"
          cloc . --exclude-dir=node_modules,.github,vendor --md >> loc_report.txt

      - name: Fetch & Analyze OTHER Repositories
        run: |
          mkdir -p /tmp/other_repos
          REPORT_PATH=$(pwd)/loc_report.txt
          
          # Get list of repos
          repos=$(gh repo list ${{ github.repository_owner }} --source --json name --limit 1000 | jq -r '.[].name')
          
          cd /tmp/other_repos
          for repo_name in $repos; do
            if [ "$repo_name" != "${{ github.event.repository.name }}" ]; then
              echo "--- Cloning and analyzing $repo_name ---"
              # Use gh repo clone to handle authentication automatically via GH_TOKEN
              gh repo clone "${{ github.repository_owner }}/$repo_name" -- --depth 1
              
              if [ -d "$repo_name" ]; then
                cloc "$repo_name" --exclude-dir=node_modules,vendor --md >> "$REPORT_PATH"
                rm -rf "$repo_name"
              fi
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Append Report to README
        run: |
          # Use a marker to replace content reliably
          # This deletes everything between the LOC markers if they exist
          sed -i '//,//d' README.md || true
          
          echo "" >> README.md
          echo "## Lines of Code Report" >> README.md
          echo "Last Updated: $(date)" >> README.md
          cat loc_report.txt >> README.md
          echo -e "\n" >> README.md

      - name: Commit Report Update
        uses: actions-js/push@v1
        with:
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          branch: main
          message: "Auto-generated: Update Lines of Code Report"
